name: Build Windows Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Download FFmpeg binaries
        run: |
          # Download the FFmpeg zip and extract the binaries
          curl -L -o ffmpeg.zip https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip
          Expand-Archive -Path ffmpeg.zip -DestinationPath ffmpeg_temp
          mkdir bin
          copy ffmpeg_temp\ffmpeg-master-latest-win64-gpl\bin\ffmpeg.exe bin\
          copy ffmpeg_temp\ffmpeg-master-latest-win64-gpl\bin\ffprobe.exe bin\
          Remove-Item -Recurse -Force ffmpeg_temp, ffmpeg.zip

      - name: Verify FFmpeg binaries
        run: |
          echo "Verifying FFmpeg binaries..."
          dir bin
          bin\ffmpeg.exe -version
          bin\ffprobe.exe -version

      - name: Build with PyInstaller
        run: |
          pyinstaller --clean cut_tool.spec

      - name: Create working_folder in dist
        run: mkdir dist\cut_tool\working_folder

      - name: Create release archive
        run: Compress-Archive -Path dist\cut_tool\* -DestinationPath arknights-cut-tool-windows.zip

      - name: Get version from tag
        id: get_version
        run: |
          if ("${{ github.ref }}" -match 'refs/tags/v(.+)') {
            $version = $matches[1]
            echo "version=$version" >> $env:GITHUB_OUTPUT
            echo "Version: $version"
          } else {
            echo "version=dev" >> $env:GITHUB_OUTPUT
            echo "Version: dev"
          }

      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-release-${{ steps.get_version.outputs.version }}
          path: arknights-cut-tool-windows.zip
          retention-days: 90

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: arknights-cut-tool-windows.zip
          name: Release ${{ steps.get_version.outputs.version }}
          body: |
            ## Arknights Auto Separate/Cut Pause Tool - Windows Release

            ### Version ${{ steps.get_version.outputs.version }}

            ### Installation
            1. Download `arknights-cut-tool-windows.zip`
            2. Extract the zip file
            3. Run `cut_tool.exe`

            ### Requirements
            - Windows 10 or later
            - FFmpeg binaries included (no separate installation needed)
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
